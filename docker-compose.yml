# Docker Compose for Solana VRF program — build, test, and deploy
# Uses official Solana Foundation images: https://hub.docker.com/u/solanafoundation
#
# Your Solana wallet is mounted into the container as the default signer.
# Default: $HOME/.config/solana/id.json — works from WSL and Linux/Mac. On Windows (PowerShell) set SOLANA_ID_JSON to the full path.

services:
  # --- Build the Anchor program ---
  program-build:
    image: solanafoundation/anchor:v0.32.1
    container_name: solana-vrf-build
    working_dir: /workspace/program
    volumes:
      - .:/workspace
      # Mount your wallet as the default signer (create with: solana-keygen new)
      - ${SOLANA_ID_JSON:-${HOME}/.config/solana/id.json}:/root/.config/solana/id.json:ro
    command: >
      sh -c "
        mkdir -p /root/.config/solana &&
        (test -f /root/.config/solana/id.json || solana-keygen new -o /root/.config/solana/id.json --no-bip39-passphrase --force) &&
        yarn install --frozen-lockfile &&
        anchor build
      "
    profiles:
      - build

  # --- Run tests (local validator + TypeScript tests) ---
  program-test:
    image: solanafoundation/anchor:v0.32.1
    container_name: solana-vrf-test
    working_dir: /workspace/program
    volumes:
      - .:/workspace
      - ${SOLANA_ID_JSON:-${HOME}/.config/solana/id.json}:/root/.config/solana/id.json:ro
    command: >
      sh -c "
        mkdir -p /root/.config/solana &&
        (test -f /root/.config/solana/id.json || solana-keygen new -o /root/.config/solana/id.json --no-bip39-passphrase --force) &&
        yarn install --frozen-lockfile &&
        (test -f /workspace/backend/vrf-signer.json || solana-keygen new -o /workspace/backend/vrf-signer.json --no-bip39-passphrase --force) &&
        anchor test
      "
    profiles:
      - test

  # --- Deploy to devnet ---
  # Uses same wallet as build/test (SOLANA_ID_JSON). Ensure it has devnet SOL.
  program-deploy-devnet:
    image: solanafoundation/anchor:v0.32.1
    container_name: solana-vrf-deploy-devnet
    working_dir: /workspace/program
    environment:
      ANCHOR_PROVIDER_URL: ${ANCHOR_PROVIDER_URL:-https://api.devnet.solana.com}
      ANCHOR_WALLET: /root/.config/solana/id.json
    volumes:
      - .:/workspace
      - ${SOLANA_ID_JSON:-${HOME}/.config/solana/id.json}:/root/.config/solana/id.json:ro
    command: >
      sh -c "
        mkdir -p /root/.config/solana &&
        yarn install --frozen-lockfile &&
        anchor build &&
        anchor deploy --provider.cluster devnet
      "
    profiles:
      - deploy-devnet

  # --- Verifiable build (deterministic build + optional verify) ---
  # See: https://hub.docker.com/r/solanafoundation/solana-verifiable-build
  program-verifiable-build:
    image: solanafoundation/solana-verifiable-build:2.2.19
    container_name: solana-vrf-verifiable-build
    working_dir: /workspace
    volumes:
      - .:/workspace
    # Default: build only. Override command to verify against on-chain program.
    # Example verify: solana-verifiable-build verify <PROGRAM_ID> ./program/target/deploy/vrf_sol.so
    command: ["build", "./program"]
    profiles:
      - verifiable

  # --- Local validator (optional; for manual testing / frontend) ---
  # Start with: docker compose --profile localnet up -d solana-test-validator
  solana-test-validator:
    image: solanafoundation/anchor:v0.32.1
    container_name: solana-vrf-validator
    command: solana-test-validator
    ports:
      - "8899:8899"   # RPC
      - "8900:8900"   # WebSocket (if exposed)
    volumes:
      - solana-validator-data:/root/.config/solana
    profiles:
      - localnet

volumes:
  solana-validator-data:
